name: Build macOS

on:
  push:
    branches: [ main, master, dev-hiroshi, 'claude/**' ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  OF_VERSION: "0.12.0"
  OF_URL: "https://github.com/openframeworks/openFrameworks/releases/download/0.12.0/of_v0.12.0_osx_release.zip"
  PROJECT: "NDI-cv5"

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache openFrameworks
        id: cache-of
        uses: actions/cache@v4
        with:
          path: ~/openFrameworks
          key: of-${{ env.OF_VERSION }}-macos-14

      - name: Download openFrameworks
        if: steps.cache-of.outputs.cache-hit != 'true'
        run: |
          echo "Downloading openFrameworks ${{ env.OF_VERSION }}..."
          curl -L -o of.zip "${{ env.OF_URL }}"
          unzip -q of.zip -d ~/
          mv ~/of_v${{ env.OF_VERSION }}_osx_release ~/openFrameworks
          echo "openFrameworks downloaded to ~/openFrameworks"

      - name: Setup project structure
        run: |
          # Link our project into the openFrameworks apps structure
          # Structure: ~/openFrameworks/apps/NST/NDI-cv5
          ln -s ${{ github.workspace }} ~/openFrameworks/apps/NST

          echo "Project structure:"
          ls -la ~/openFrameworks/apps/NST/

      - name: Run ProjectGenerator
        run: |
          cd ~/openFrameworks

          # ProjectGenerator is included in the OF release
          PG_APP="projectGenerator/projectGenerator.app"
          PG_PATH="$PG_APP/Contents/Resources/app/app/projectGenerator"

          # Workaround for GateKeeper: move app out and back to clear quarantine
          mv "$PG_APP" /tmp/
          mv /tmp/projectGenerator.app "$PG_APP"

          # Also remove quarantine attribute if present
          xattr -dr com.apple.quarantine "$PG_APP" 2>/dev/null || true

          echo "Using ProjectGenerator at: $PG_PATH"
          echo "ProjectGenerator version/help:"
          "$PG_PATH" --help || true

          # Generate/Update project
          PROJECT_PATH="$HOME/openFrameworks/apps/NST/${{ env.PROJECT }}"

          echo "Generating project at: $PROJECT_PATH"
          echo "addons.make contents:"
          cat "$PROJECT_PATH/addons.make" || true

          # Run with platform specified
          "$PG_PATH" -o"$HOME/openFrameworks" -p"osx" "$PROJECT_PATH"

      - name: Build with xcodebuild
        run: |
          cd ~/openFrameworks/apps/NST/${{ env.PROJECT }}

          # Find the xcodeproj
          XCODEPROJ=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
          echo "Building $XCODEPROJ..."

          # Build Release configuration
          xcodebuild \
            -project "$XCODEPROJ" \
            -scheme "${{ env.PROJECT }}" \
            -configuration Release \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            build

      - name: Ad-hoc code sign
        run: |
          cd ~/openFrameworks/apps/NST/${{ env.PROJECT }}

          # Find the built app
          APP_PATH=$(find bin -name "*.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "Error: No .app bundle found!"
            find . -name "*.app" -type d
            exit 1
          fi

          echo "Found app at: $APP_PATH"

          # Ad-hoc sign the app and all nested frameworks/dylibs
          echo "Ad-hoc signing the application..."

          # Sign all nested code first (frameworks, dylibs, etc.)
          find "$APP_PATH" -type f \( -name "*.dylib" -o -name "*.framework" \) -exec codesign --force --deep --sign - {} \; 2>/dev/null || true

          # Sign the main app bundle
          codesign --force --deep --sign - "$APP_PATH"

          # Verify the signature
          codesign --verify --verbose "$APP_PATH"

          echo "Code signing complete!"

      - name: Create release package
        run: |
          cd ~/openFrameworks/apps/NST/${{ env.PROJECT }}

          APP_PATH=$(find bin -name "*.app" -type d | head -1)
          APP_NAME=$(basename "$APP_PATH" .app)

          # Create a release directory
          RELEASE_DIR="release"
          mkdir -p "$RELEASE_DIR"

          # Copy the app to release directory
          cp -r "$APP_PATH" "$RELEASE_DIR/"

          # Create the zip
          cd "$RELEASE_DIR"
          ZIP_NAME="${{ env.PROJECT }}-macOS-${{ github.ref_name }}.zip"

          # Use ditto for better macOS compatibility (preserves extended attributes)
          ditto -c -k --keepParent "$APP_NAME.app" "$ZIP_NAME"

          echo "Created: $ZIP_NAME"
          ls -la "$ZIP_NAME"

          # Move zip to workspace for upload
          mv "$ZIP_NAME" ${{ github.workspace }}/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT }}-macOS
          path: ${{ env.PROJECT }}-macOS-*.zip
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
          generate_release_notes: true
